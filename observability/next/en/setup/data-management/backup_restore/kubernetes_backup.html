<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kubernetes backup :: SUSE® Rancher Prime: Observability</title>
    <link rel="prev" href="README.html">
    <link rel="next" href="configuration_backup.html">
    <meta name="description" content="SUSE Observability Self-hosted">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../../../_/css/search.css">
<link rel="icon" href="../../../../../../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="../../../../../../_/css/font-styles.css">
<link rel="stylesheet" href="../../../../../../_/fonts/css/all.css">
<link rel="stylesheet" href="../../../../../../_/css/site-extra.css">
<link rel="stylesheet" href="../../../../../../_/css/vendor/tabs.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
href="https://fonts.googleapis.com/css2?family=SUSE:wght@100..800&display=swap" rel="stylesheet">
<link href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" rel="stylesheet">
<!-- <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="../../../../../../_/css/vendor/light.css">
<!-- <script src="/docserv/res/lightheaded/analytics.js"
        type="text/javascript"></script> -->
    <script>var uiRootPath = '../../../../../../_'</script>
  </head>
  <body class="article">
<script type="module">import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs'; mermaid.initialize({"startOnLoad":true});</script><header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a class=" navbar-logo" href="https://documentation.suse.com/" aria-label="SUSE Documentation Home"><img class="logo"
            src="../../../../../../_/img/logo.svg" alt="SUSE logo"/></a>
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label class="visual-search-label" for="search-input">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label>
          <input label="Search" aria-label="Search" id="search-input" type="text" placeholder="Search the docs" >
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">
            <img src="../../../../../../_/img/resources.png" class="langIcon Resurces" alt="Resources" title="Resources">
          </div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/rancher/stackstate-product-docs"><i class="fab fa-github"></i>&nbsp;Observability</a>
            <div class="has-submenu">
              <a class="navbar-item" href="#" ><i class="fas fa-file-alt"></i>&nbsp;Report Issue &nbsp;<i class="fas fa-chevron-right"></i></a>
              <div class="submenu">
                <a class="navbar-item" href="https://scc.suse.com">SCC (Recommended)</a>
                <a class="navbar-item" href="https://github.com/rancher/stackstate-product-docs/issues">GitHub Issue</a>
              </div>
            </div>
            <a class="navbar-item" href="https://github.com/rancher/product-docs-playbook/blob/main/CONTRIBUTING.md"><i class="fas fa-user-edit"></i>&nbsp;Contribute</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link"><img src="../../../../../../_/img/language.png" class="langIcon Language" alt="Language"
              title="Language"></div>
          <div class="navbar-dropdown">
            <!--  </div><div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div> -->
              <a role="button" class="navbar-item" id="en" onclick="selectLanguage(this.id)">
                <!--<img src="../../../../../../_/img/engFlag.svg" class="langIcon english">-->
                &nbsp;English
              </a>
            <!-- LANGUAGESELECTOR -->
          </div>
        </div>
        <!--
        <div class="navbar-item">
          <a href="https://twitter.com/SUSE">
            <img alt="X-logo" class="x-logo" src="../../../../../../_/img/x-logo-white.png">
          </a>
        </div>
        -->
      </div>
    </div>

    <!--   <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">

        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div> -->
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="observability" data-version="next">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../../../classic.html">Observability</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#README.adoc">SUSE Observability docs!</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../classic.html">Docs for all SUSE Observability products</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../k8s-quick-start-guide.html">Quick start guide</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../k8s-getting-started.html">SUSE Observability walk-through</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../../k8s-suse-rancher-prime.html">SUSE Rancher Prime</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../k8s-suse-rancher-prime-air-gapped.html">Air-gapped</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../k8s-suse-rancher-prime-agent-air-gapped.html">Agent Air-gapped</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/troubleshooting/k8s-guided-troubleshooting.html">What is guided troubleshooting?</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/troubleshooting/k8s-configuration.html">YAML Configuration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/troubleshooting/k8s-changes.html">Changes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/troubleshooting/k8s-logs.html">Logs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/alerting/k8s-monitors.html">Monitors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/alerting/kubernetes-monitors.html">Out of the box monitors for Kubernetes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../../use/alerting/notifications/README.html">Notifications</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/alerting/notifications/configure.html">Configure notifications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../../use/alerting/notifications/channels/README.html">Notification channels</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../use/alerting/notifications/channels/slack.html">Slack</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../use/alerting/notifications/channels/teams.html">Teams</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../use/alerting/notifications/channels/webhook.html">Webhook</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../use/alerting/notifications/channels/opsgenie.html">Opsgenie</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/alerting/notifications/troubleshooting.html">Troubleshooting</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="#dynamic/customize-alerting.adoc">Customize</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/alerting/k8s-add-monitors-cli.html">Add a monitor using the CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/alerting/k8s-override-monitor-arguments.html">Override monitor arguments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/alerting/k8s-write-remediation-guide.html">Write a remediation guide</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/metrics/k8sTs-explore-metrics.html">Explore Metrics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="#dynamic/custom-charts.adoc">Custom charts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/metrics/k8s-add-charts.html">Adding custom charts to components</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/metrics/k8s-writing-promql-for-charts.html">Writing PromQL queries for representative charts</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/metrics/k8sTs-metrics-troubleshooting.html">Troubleshooting custom charts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="#dynamic/advanced-metrics.adoc">Advanced Metrics</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/metrics/k8s-stackstate-grafana-datasource.html">Grafana Datasource</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/metrics/k8s-prometheus-remote-write.html">Prometheus remote_write</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/metrics/open-metrics.html">OpenMetrics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/logs/k8sTs-explore-logs.html">Explore Logs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/logs/k8sTs-log-shipping.html">Log Shipping</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/traces/k8sTs-explore-traces.html">Explore Traces</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../configure/health/health-synchronization.html">Health synchronization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../../configure/health/send-health-data/README.html">Send health data over HTTP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../configure/health/send-health-data/send-health-data.html">Send health data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../configure/health/send-health-data/repeat_snapshots.html">Repeat Snapshots JSON</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../configure/health/send-health-data/repeat_states.html">Repeat States JSON</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../configure/health/send-health-data/transactional_increments.html">Transactional Increments JSON</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../configure/health/debug-health-sync.html">Debug health synchronization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/views/k8s-views.html">Kubernetes views</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/views/k8s-custom-views.html">Custom views</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/views/k8s-component-views.html">Component views</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/views/k8s-explore-views.html">Explore views</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../../use/views/k8s-view-structure.html">View structure</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/views/k8s-overview-perspective.html">Overview perspective</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/views/k8s-highlights-perspective.html">Highlights perspective</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/views/k8s-topology-perspective.html">Topology perspective</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/views/k8s-events-perspective.html">Events perspective</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/views/k8s-metrics-perspective.html">Metrics perspective</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/views/k8s-traces-perspective.html">Traces perspective</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/views/k8s-filters.html">Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../use/stackstate-ui/k8sTs-keyboard-shortcuts.html">Keyboard shortcuts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/stackstate-ui/k8sTs-timeline-time-travel.html">Timeline and time travel</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../k8s-network-configuration-saas.html">Network configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../agent/k8s-network-configuration-proxy.html">Proxy Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../k8s-suse-rancher-prime-agent-air-gapped.html">Using a custom registry</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../agent/k8s-custom-secrets-setup.html">Custom Secret Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../agent/k8sTs-agent-request-tracing.html">Request tracing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../agent/k8sTs-agent-request-tracing-certificates.html">Certificates for sidecar injection</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../otel/getting-started.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../otel/collector.html">Open telemetry collector</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../otel/languages/README.html">Languages</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../otel/languages/sdk-exporter-config.html">Generic Exporter configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../otel/languages/java.html">Java</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../otel/languages/node.js.html">Node.js</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../otel/languages/dot-net.html">.NET</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../otel/languages/verify.html">Verify the results</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../otel/troubleshooting.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../cli/cli-sts.html">SUSE Observability CLI</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../install-stackstate/README.html">Install SUSE Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../install-stackstate/requirements.html">Requirements</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/README.html">Kubernetes / OpenShift</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/kubernetes_install.html">Kubernetes install</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/openshift_install.html">OpenShift install</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/required_permissions.html">Required Permissions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/customize_config.html">Override default configuration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/storage.html">Configure storage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/ingress.html">Exposing SUSE Observability outside of the cluster</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../install-stackstate/initial_run_guide.html">Initial run guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../install-stackstate/troubleshooting.html">Troubleshooting</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../configure/logging/kubernetes-logs.html">Logs</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../configure-stackstate/README.html">Configure SUSE Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../configure-stackstate/slack-notifications.html">Slack notifications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../configure-stackstate/email-notifications.html">E-mail notifications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../stackpacks/about-stackpacks.html">Stackpacks</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../release-notes/README.html">Release Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/20240911112250.html">v2.0.0 - 11/09/2024</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/20240918082712.html">v2.0.1 - 18/09/2024</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/20241001154902.html">v2.0.2 - 01/10/2024</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../upgrade-stackstate/README.html">Upgrade SUSE Observability</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../upgrade-stackstate/steps-to-upgrade.html">Steps to upgrade</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../upgrade-stackstate/version-specific-upgrade-instructions.html">Version-specific upgrade instructions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/uninstall.html">Uninstall SUSE Observability</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../install-stackstate/kubernetes_openshift/no_internet/README.html">Air-gapped</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../k8s-suse-rancher-prime-air-gapped.html">SUSE Observability air-gapped</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../k8s-suse-rancher-prime-agent-air-gapped.html">SUSE Observability Kubernetes Agent air-gapped</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../README.html">Data management</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="README.html">Backup and Restore</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="kubernetes_backup.html">Kubernetes backup</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="configuration_backup.html">Configuration backup</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../data_retention.html">Data retention</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../clear_stored_data.html">Clear stored data</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../security/README.html">Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../security/authentication/README.html">Authentication</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/authentication/authentication_options.html">Authentication options</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/authentication/file.html">File-based</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/authentication/ldap.html">LDAP</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/authentication/oidc.html">Open ID Connect (OIDC)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/authentication/keycloak.html">KeyCloak</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/authentication/service_tokens.html">Service tokens</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle" aria-label="Toggle expand/collapse"></button>
    <a class="nav-link" href="../../security/rbac/README.html">RBAC</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/rbac/role_based_access_control.html">Role-based Access Control</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/rbac/rbac_permissions.html">Permissions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/rbac/rbac_roles.html">Roles</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../security/rbac/rbac_scopes.html">Scopes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/self-signed-certificates.html">Self-signed certificates</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/security/k8s-service-tokens.html">Service Tokens</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../use/security/k8s-ingestion-api-keys.html">Ingestion API Keys</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../saas/user-management.html">User Management</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../develop/reference/k8sTs-stql_reference.html">SUSE Observability Query Language (STQL)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../develop/reference/k8sTs-chart-units.html">Chart units</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../configure/topology/identifiers.html">Topology Identifiers</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Observability</span>
    <span class="version">Next</span>
  </div>
  <ul class="components">
        <li class="component is-current">
          <div class="title"><a href="../../../classic.html">Observability</a></div>
          <ul class="versions">
            <li class="version is-current is-latest">
              <a href="../../../classic.html">Next</a>
            </li>
          </ul>
        </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../classic.html" aria-label="Home" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../classic.html">Observability</a></li>
    <li><a href="../README.html">Data management</a></li>
    <li><a href="README.html">Backup and Restore</a></li>
    <li><a href="kubernetes_backup.html">Kubernetes backup</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/rancher/stackstate-product-docs/edit/main/docs/next/modules/en/pages/setup/data-management/backup_restore/kubernetes_backup.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="On this page" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Kubernetes backup</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Kubernetes setup for SUSE Observability has a built-in backup and restore mechanism that can be configured to store backups to the local clusters, to AWS S3 or to Azure Blob Storage.</p>
</div>
<div class="sect2">
<h3 id="_backup_scope"><a class="anchor" href="#_backup_scope"></a>Backup scope</h3>
<div class="paragraph">
<p>The following data can be automatically backed up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Configuration and topology data</strong> stored in StackGraph is backed up when the Helm value <code>backup.stackGraph.enabled</code> is set to <code>true</code>.</p>
</li>
<li>
<p><strong>Metrics</strong> stored in SUSE Observability&#8217;s Victoria Metrics instance(s) is backed up when the Helm value <code>victoria-metrics-0.backup.enabled</code> and <code>victoria-metrics-1.backup.enabled</code> are set to <code>true</code>.</p>
</li>
<li>
<p><strong>Telemetry data</strong> stored in SUSE Observability&#8217;s Elasticsearch instance is backed up when the Helm value <code>backup.elasticsearch.enabled</code> is set to <code>true</code>.</p>
</li>
<li>
<p><strong>OpenTelemetry data</strong> stored in SUSE Observability&#8217;s ClickHouse instance is backed up when the Helm value <code>clickhouse.backup.enabled</code> is set to <code>true</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following data will <strong>not</strong> be backed up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In transit topology and telemetry updates stored in Kafka - these only have temporary value and would be of no use when a backup is restored</p>
</li>
<li>
<p>Master node negotiations state stored in ZooKeeper - this runtime state would be incorrect when restored and will be automatically determined at runtime</p>
</li>
<li>
<p>Kubernetes configuration state and raw persistent volume state - this state can be rebuilt by re-installing SUSE Observability and restoring the backups.</p>
</li>
<li>
<p>Kubernetes logs - these are ephemeral.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_storage_options"><a class="anchor" href="#_storage_options"></a>Storage options</h3>
<div class="paragraph">
<p>Backups are sent to an instance of <a href="https://min.io/">MinIO (min.io)</a>, which is automatically started by the <code>stackstate</code> Helm chart when automatic backups are enabled. MinIO is an object storage system with the same API as AWS S3. It can store its data locally or act as a gateway to <a href="https://docs.min.io/docs/minio-gateway-for-s3.html">AWS S3 (min.io)</a>, <a href="https://docs.min.io/docs/minio-gateway-for-azure.html">Azure BLob Storage (min.io)</a> and other systems.</p>
</div>
<div class="paragraph">
<p>The built-in MinIO instance can be configured to store the backups in three locations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#aws-s3">AWS S3</a></p>
</li>
<li>
<p><a href="#azure-blob-storage">Azure Blob Storage</a></p>
</li>
<li>
<p><a href="#kubernetes-storage">Kubernetes storage</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_enable_backups"><a class="anchor" href="#_enable_backups"></a>Enable backups</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_aws_s3"><a class="anchor" href="#_aws_s3"></a>AWS S3</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Encryption</strong></p>
</div>
<div class="paragraph">
<p>Amazon S3-managed keys (SSE-S3) should be used when encrypting S3 buckets that store the backups.</p>
</div>
<div class="paragraph">
<p>⚠️ Encryption with AWS KMS keys stored in AWS Key Management Service (SSE-KMS) isn&#8217;t supported. This will result in errors such as this one in the Elasticsearch logs:</p>
</div>
<div class="paragraph">
<p><code>Caused by: org.elasticsearch.common.io.stream.NotSerializableExceptionWrapper: sdk_client_exception: Unable to verify integrity of data upload. Client calculated content hash (contentMD5: ZX4D/ZDUzZWRhNDUyZTI1MTc= in base 64) didn&#8217;t match hash (etag: c75faa31280154027542f6530c9e543e in hex) calculated by Amazon S3. You may need to delete the data stored in Amazon S3. (metadata.contentMD5: null, md5DigestStream: com.amazonaws.services.s3.internal.MD5DigestCalculatingInputStream@5481a656, bucketName: stackstate-elasticsearch-backup, key: tests-UG34QIV9s32tTzQWdPsZL/master.dat)",</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To enable scheduled backups to AWS S3 buckets, add the following YAML fragment to the Helm <code>values.yaml</code> file used to install SUSE Observability:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">backup:
  enabled: true
  stackGraph:
    bucketName: AWS_STACKGRAPH_BUCKET
  elasticsearch:
    bucketName: AWS_ELASTICSEARCH_BUCKET
victoria-metrics-0:
  backup:
    bucketName: AWS_VICTORIA_METRICS_BUCKET
victoria-metrics-1:
  backup:
    bucketName: AWS_VICTORIA_METRICS_BUCKET
clickhouse:
  backup:
    enabled: true
    bucketName: AWS_CLICKHOUSE_BUCKET
minio:
  accessKey: YOUR_ACCESS_KEY
  secretKey: YOUR_SECRET_KEY
  s3gateway:
    enabled: true
    accessKey: AWS_ACCESS_KEY
    secretKey: AWS_SECRET_KEY</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>YOUR_ACCESS_KEY</code> and <code>YOUR_SECRET_KEY</code> are the credentials that will be used to secure the MinIO system. These credentials are set on the MinIO system and used by the automatic backup jobs and the restore jobs. They&#8217;re also required if you want to manually access the MinIO system.</p>
<div class="ulist">
<ul>
<li>
<p>YOUR_ACCESS_KEY should contain 5 to 20 alphanumerical characters.</p>
</li>
<li>
<p>YOUR_SECRET_KEY should contain 8 to 40 alphanumerical characters.</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>AWS_ACCESS_KEY</code> and <code>AWS_SECRET_KEY</code> are the AWS credentials for the IAM user that has access to the S3 buckets where the backups will be stored. See below for the permission policy that needs to be attached to that user.</p>
</li>
<li>
<p><code>AWS_STACKGRAPH_BUCKET</code>, <code>AWS_ELASTICSEARCH_BUCKET</code>, <code>AWS_VICTORIA_METRICS_BUCKET</code> and <code>AWS_CLICKHOUSE_BUCKET</code> are the names of the S3 buckets where the backups should be stored. Note: The names of AWS S3 buckets are global across the whole of AWS, therefore the S3 buckets with the default name (<code>sts-elasticsearch-backup</code>, <code>sts-stackgraph-backup</code>, <code>sts-victoria-metrics-backup</code> and <code>sts-clickhouse-backup</code> ) will probably not be available.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The IAM user identified by <code>AWS_ACCESS_KEY</code> and <code>AWS_SECRET_KEY</code> must be configured with the following permission policy to access the S3 buckets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowListMinioBackupBuckets",
            "Effect": "Allow",
            "Action": [
                "s3:ListBucket",
                "s3:GetBucketLocation"
            ],
            "Resource": [
                "arn:aws:s3:::AWS_STACKGRAPH_BUCKET",
                "arn:aws:s3:::AWS_ELASTICSEARCH_BUCKET",
                "arn:aws:s3:::AWS_VICTORIA_METRICS_BUCKET",
                "arn:aws:s3:::AWS_CLICKHOUSE_BUCKET"
            ]
        },
        {
            "Sid": "AllowWriteMinioBackupBuckets",
            "Effect": "Allow",
            "Action": [
                "s3:PutObject",
                "s3:GetObject",
                "s3:DeleteObject"
            ],
            "Resource": [
                "arn:aws:s3:::AWS_STACKGRAPH_BUCKET/*",
                "arn:aws:s3:::AWS_ELASTICSEARCH_BUCKET/*",
                "arn:aws:s3:::AWS_VICTORIA_METRICS_BUCKET/*",
                "arn:aws:s3:::AWS_CLICKHOUSE_BUCKET/*"
            ]
        }
    ]
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_azure_blob_storage"><a class="anchor" href="#_azure_blob_storage"></a>Azure Blob Storage</h3>
<div class="paragraph">
<p>To enable backups to an Azure Blob Storage account, add the following YAML fragment to the Helm <code>values.yaml</code> file used to install SUSE Observability:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">backup:
  enabled: true
minio:
  accessKey: AZURE_STORAGE_ACCOUNT_NAME
  secretKey: AZURE_STORAGE_ACCOUNT_KEY
  azuregateway:
    enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AZURE_STORAGE_ACCOUNT_NAME</code> - the <a href="https://learn.microsoft.com/en-us/azure/storage/common/storage-account-create?tabs=azure-portal">Azure storage account name (learn.microsoft.com)</a></p>
</li>
<li>
<p><code>AZURE_STORAGE_ACCOUNT_KEY</code> - the <a href="https://learn.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal">Azure storage account key (learn.microsoft.com)</a> where the backups should be stored.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The StackGraph, Elasticsearch and Victoria Metrics backups are stored in BLOB containers called <code>sts-stackgraph-backup</code>, <code>sts-elasticsearch-backup</code>, <code>sts-victoria-metrics-backup</code>, <code>sts-clickhouse-backup</code> respectively. These names can be changed by setting the Helm values <code>backup.stackGraph.bucketName</code>, <code>backup.elasticsearch.bucketName</code>, <code>victoria-metrics-0.backup.bucketName</code>, <code>victoria-metrics-1.backup.bucketName</code> and <code>clickhouse.backup.bucketName</code> respectively.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kubernetes_storage"><a class="anchor" href="#_kubernetes_storage"></a>Kubernetes storage</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If MinIO is configured to store its data in Kubernetes storage, a PersistentVolumeClaim (PVC) is used to request storage from the Kubernetes cluster. The kind of storage allocated depends on the configuration of the cluster.</p>
</div>
<div class="paragraph">
<p>It&#8217;s advised to use AWS S3 for clusters running on Amazon AWS and Azure Blob Storage for clusters running on Azure for the following reasons:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Kubernetes clusters running in a cloud provider usually map PVCs to block storage, such as Elastic Block Storage for AWS or Azure Block Storage. Block storage is expensive, especially for large data volumes.</p>
</li>
<li>
<p>Persistent Volumes are destroyed when the cluster that created them is destroyed. That means an (accidental) deletion of your cluster will also destroy all backups stored in Persistent Volumes.</p>
</li>
<li>
<p>Persistent Volumes can&#8217;t be accessed from another cluster. That means that it isn&#8217;t possible to restore SUSE Observability from a backup taken on another cluster.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To enable backups to cluster-local storage, enable MinIO by adding the following YAML fragment to the Helm <code>values.yaml</code> file used to install SUSE Observability:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">backup:
  enabled: true
minio:
  accessKey: YOUR_ACCESS_KEY
  secretKey: YOUR_SECRET_KEY
  persistence:
    enabled: true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace the following values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>YOUR_ACCESS_KEY</code> and <code>YOUR_SECRET_KEY</code> - the credentials that will be used to secure the MinIO system. The automatic backup jobs and the restore jobs will use them. They&#8217;re also required to manually access the MinIO storage. <code>YOUR_ACCESS_KEY</code> should contain 5 to 20 alphanumerical characters and <code>YOUR_SECRET_KEY</code> should contain 8 to 40 alphanumerical characters.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_and_topology_data_stackgraph"><a class="anchor" href="#_configuration_and_topology_data_stackgraph"></a>Configuration and topology data (StackGraph)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Configuration and topology data (StackGraph) backups are full backups, stored in a single file with the extension <code>.graph</code>. Each file contains a full backup and can be moved, copied or deleted as required.</p>
</div>
<div class="sect2">
<h3 id="_disable_scheduled_backups"><a class="anchor" href="#_disable_scheduled_backups"></a>Disable scheduled backups</h3>
<div class="paragraph">
<p>When <code>backup.enabled</code> is set to <code>true</code>, scheduled StackGraph backups are enabled by default. To disable scheduled StackGraph backups only, set the Helm value <code>backup.stackGraph.scheduled.enabled</code> to <code>false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_disable_restores"><a class="anchor" href="#_disable_restores"></a>Disable restores</h3>
<div class="paragraph">
<p>When <code>backup.enabled</code> is set to <code>true</code>, StackGraph restores are enabled by default. To disable StackGraph restore functionality only, set the Helm value <code>backup.stackGraph.restore.enabled</code> to <code>false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_backup_schedule"><a class="anchor" href="#_backup_schedule"></a>Backup schedule</h3>
<div class="paragraph">
<p>By default, the StackGraph backups are created daily at 03:00 AM server time.</p>
</div>
<div class="paragraph">
<p>The backup schedule can be configured using the Helm value <code>backup.stackGraph.scheduled.schedule</code>, specified in <a href="https://kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/#cron-schedule-syntax">Kubernetes cron schedule syntax (kubernetes.io)</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_backup_retention"><a class="anchor" href="#_backup_retention"></a>Backup retention</h3>
<div class="paragraph">
<p>By default, the StackGraph backups are kept for 30 days. As StackGraph backups are full backups, this can require a lot of storage.</p>
</div>
<div class="paragraph">
<p>The backup retention delta can be configured using the Helm value <code>backup.stackGraph.scheduled.backupRetentionTimeDelta</code>, specified in <a href="https://docs.python.org/3/library/datetime.html#timedelta-objects">Python timedelta format (python.org)</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_metrics_victoria_metrics"><a class="anchor" href="#_metrics_victoria_metrics"></a>Metrics (Victoria Metrics)</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Victoria Metrics use incremental backups without versioning of a bucket, it means that the new backup <strong>replaces completely the previous one</strong>.</p>
</div>
<div class="paragraph">
<p>In case you run into one of the following situations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mount an empty volume to <code>/storage</code> directory of Victoria Metrics instances</p>
</li>
<li>
<p>delete the <code>/storage</code> directory or files inside from Victoria Metrics instances</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The next (empty) backup created will be labeled with a new version and the previous one, before the volume was emptied, will be preserved.
Both backups will be from that moment on <a href="#list-victoria-metrics-backups">listed as available for restore</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Metrics (Victoria Metrics) use instant snapshots to store data in incremental backups. Many instances of Victoria Metrics can store backups to the same bucket, each of them will be stored in separated directory. All files located in the directory should be treated as a single whole and can only be moved, copied or deleted as a whole.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>High Available deployments should be deployed with two instances of Victoria Metrics. Backups are enabled/configured independently for each of them.</p>
</div>
<div class="paragraph">
<p>The following code snippets/commands are provided for the first instance of Victoria Metric <code>victoria-metrics-0</code>. To backup/configure the second instance you should use <code>victoria-metrics-1</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_enable_scheduled_backups"><a class="anchor" href="#_enable_scheduled_backups"></a>Enable scheduled backups</h3>
<div class="paragraph">
<p>Backups of Victoria Metrics are disabled by default. To enabled scheduled Victoria Metrics backups, set the Helm value <code>victoria-metrics-0.backup.enabled</code> to <code>true</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Victoria Metrics backups requires to <a href="#enable-backups">enable backups</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_enable_restores"><a class="anchor" href="#_enable_restores"></a>Enable restores</h3>
<div class="paragraph">
<p>Restore functionality of Victoria Metrics are disabled by default. To enabled restore functionality of Victoria Metrics, set the Helm value <code>victoria-metrics-0.restore.enabled</code> to <code>true</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Victoria Metrics restore functionality requires to <a href="#enable-backups">enable backups</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_backup_schedule_2"><a class="anchor" href="#_backup_schedule_2"></a>Backup schedule</h3>
<div class="paragraph">
<p>By default, the Victoria Metrics backups are created every 1h:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>victoria-metrics-0</code> - 25 minutes past the hour</p>
</li>
<li>
<p><code>victoria-metrics-1</code> - 35 minutes past the hour</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The backup schedule can be configured using the Helm value <code>victoria-metrics-0.backup.scheduled.schedule</code> according <a href="https://github.com/aptible/supercronic/tree/master/cronexpr">cronexpr format</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_opentelemetry_clickhouse"><a class="anchor" href="#_opentelemetry_clickhouse"></a>OpenTelemetry (ClickHouse)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ClickHouse uses both incremental and full backups. By default, full backups are executed daily at 00:45 am, and incremental backups are performed every hour. Each backup creates a new directory, old backups (directories) are deleted automatically. All files located in a backup directory should be treated as a single whole and can only be moved, copied or deleted as a whole. We recommend to uses <code>clickhouse-backup</code> tool to manage backups. The tool is available on the <code>stackstate-clickhouse-shard0-0</code> Pod.</p>
</div>
<div class="sect2">
<h3 id="_enable_scheduled_backups_2"><a class="anchor" href="#_enable_scheduled_backups_2"></a>Enable scheduled backups</h3>
<div class="paragraph">
<p>Backups of the ClickHouse are disabled by default. To enabled scheduled ClickHouse backups, set the Helm value <code>clickhouse.backup.enabled</code> to <code>true</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ClickHouse backups requires to <a href="#enable-backups">enable backups</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_enable_restores_2"><a class="anchor" href="#_enable_restores_2"></a>Enable restores</h3>
<div class="paragraph">
<p>Restore functionality of the ClickHouse are disabled by default. To enabled restore functionality of the ClickHouse, set the Helm value <code>clickhouse.restore.enabled</code> to <code>true</code>.</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ClickHouse restore functionality requires to <a href="#enable-backups">enable backups</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_backup_schedule_3"><a class="anchor" href="#_backup_schedule_3"></a>Backup schedule</h3>
<div class="paragraph">
<p>By default, the ClickHouse backups are created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Full Backup - at 00:45 every day</p>
</li>
<li>
<p>Incremental Backup - 45 minutes past the hour (from 3 am to 12 am)</p>
</li>
</ul>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Backups struggle with parallel execution. If a second backup starts before the first one completes, it will disrupt the first backup. Therefore, it&#8217;s crucial to avoid parallel execution. For instance, the first incremental backup should be executed three hours after the full one.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The backup schedule can be configured using the Helm value <code>clickhouse.backup.scheduled.full_schedule</code> and <code>clickhouse.backup.scheduled.incremental_schedule</code> according <a href="https://github.com/aptible/supercronic/tree/master/cronexpr">cronexpr format</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_backup_retention_2"><a class="anchor" href="#_backup_retention_2"></a>Backup retention</h3>
<div class="paragraph">
<p>By default, the tooling keeps last 308 backups (full and incremental) what is equal to ~14 days.</p>
</div>
<div class="paragraph">
<p>The backup retention can be configured using the Helm value <code>clickhouse.backup.config.keep_remote</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_telemetry_data_elasticsearch"><a class="anchor" href="#_telemetry_data_elasticsearch"></a>Telemetry data (Elasticsearch)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The telemetry data (Elasticsearch) snapshots are incremental and stored in files with the extension <code>.dat</code>. The files in the Elasticsearch backup storage location should be treated as a single whole and can only be moved, copied or deleted as a whole.</p>
</div>
<div class="paragraph">
<p>The configuration snippets provided in the section <a href="kubernetes_backup.adoc#enable-backups">enable backups</a> will enable daily Elasticsearch snapshots.</p>
</div>
<div class="sect2">
<h3 id="_disable_scheduled_snapshots"><a class="anchor" href="#_disable_scheduled_snapshots"></a>Disable scheduled snapshots</h3>
<div class="paragraph">
<p>When <code>backup.enabled</code> is set to <code>true</code>, scheduled Elasticsearch snapshots are enabled by default. To disable scheduled Elasticsearch snapshots only, set the Helm value <code>backup.elasticsearch.scheduled.enabled</code> to <code>false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_disable_restores_2"><a class="anchor" href="#_disable_restores_2"></a>Disable restores</h3>
<div class="paragraph">
<p>When <code>backup.enabled</code> is set to <code>true</code>, Elasticsearch restores are enabled by default. To disable Elasticsearch restore functionality only, set the Helm value <code>backup.elasticsearch.restore.enabled</code> to <code>false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_snapshot_schedule"><a class="anchor" href="#_snapshot_schedule"></a>Snapshot schedule</h3>
<div class="paragraph">
<p>By default, Elasticsearch snapshots are created daily at 03:00 AM server time.</p>
</div>
<div class="paragraph">
<p>The backup schedule can be configured using the Helm value <code>backup.elasticsearch.scheduled.schedule</code>, specified in <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/cron-expressions.html">Elasticsearch cron schedule syntax (elastic.co)</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_snapshot_retention"><a class="anchor" href="#_snapshot_retention"></a>Snapshot retention</h3>
<div class="paragraph">
<p>By default, Elasticsearch snapshots are kept for 30 days, with a minimum of 5 snapshots and a maximum of 30 snapshots.</p>
</div>
<div class="paragraph">
<p>The retention time and number of snapshots kept can be configured using the following Helm values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>backup.elasticsearch.scheduled.snapshotRetentionExpireAfter</code>, specified in <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/common-options.html#time-units">Elasticsearch time units (elastic.co)</a>.</p>
</li>
<li>
<p><code>backup.elasticsearch.scheduled.snapshotRetentionMinCount</code></p>
</li>
<li>
<p><code>backup.elasticsearch.scheduled.snapshotRetentionMaxCount</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, the retention task itself <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/slm-settings.html#slm-retention-schedule">runs daily at 1:30 AM UTC (elastic.co)</a>. If you set snapshots to expire faster than within a day, for example for testing purposes, you will need to change the schedule for the retention task.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_snapshot_indices"><a class="anchor" href="#_snapshot_indices"></a>Snapshot indices</h3>
<div class="paragraph">
<p>By default, a snapshot is created for Elasticsearch indices with names that start with <code>sts</code>.</p>
</div>
<div class="paragraph">
<p>The indices for which a snapshot is created can be configured using the Helm value <code>backup.elasticsearch.scheduled.indices</code>, specified in <a href="https://www.w3schools.com/js/js_json_arrays.asp">JSON array format (w3schools.com)</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_restore_backups_and_snapshots"><a class="anchor" href="#_restore_backups_and_snapshots"></a>Restore backups and snapshots</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Scripts to list and restore backups and snapshots can be found in the <a href="https://github.com/StackVista/helm-charts/tree/master/stable/suse-observability/restore">restore directory of the SUSE Observability Helm chart repository (github.com)</a>. To use the scripts, download them from GitHub or checkout the repository.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Before you use the scripts, ensure that:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>kubectl</code> binary is installed and configured to connect to:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The Kubernetes cluster where SUSE Observability has been installed.</p>
</li>
<li>
<p>The namespace within that cluster where SUSE Observability has been installed.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The following Helm values have been correctly set:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>backup.enabled</code> is set to <code>true</code>.</p>
</li>
<li>
<p><code>backup.stackGraph.restore.enabled</code> isn&#8217;t set to <code>false</code> (to access StackGraph backups).</p>
</li>
<li>
<p><code>backup.elasticsearch.restore.enabled</code> isn&#8217;t set to <code>false</code> (to access Elasticsearch snapshots).</p>
</li>
<li>
<p><code>victoria-metrics-0.restore.enabled</code> or <code>victoria-metrics-1.restore.enabled</code> isn&#8217;t set to <code>false</code> (to access Victoria Metrics snapshots).</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_list_stackgraph_backups"><a class="anchor" href="#_list_stackgraph_backups"></a>List StackGraph backups</h3>
<div class="paragraph">
<p>To list the StackGraph backups, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/list-stackgraph-backups.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">job.batch/stackgraph-list-backups-20210222t111942 created
Waiting for job to start...
=== Listing StackGraph backups in bucket "sts-stackgraph-backup"...
sts-backup-20210215-0300.graph
sts-backup-20210216-0300.graph
sts-backup-20210217-0300.graph
sts-backup-20210218-0300.graph
sts-backup-20210219-0300.graph
sts-backup-20210220-0300.graph
sts-backup-20210221-0300.graph
sts-backup-20210222-0300.graph
===
job.batch "stackgraph-list-backups-20210222t111942" deleted</code></pre>
</div>
</div>
<div class="paragraph">
<p>The timestamp when the backup was taken is part of the backup name.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Lines in the output that start with <code>Error from server (BadRequest):</code> are expected. They appear when the script is waiting for the pod to start.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_restore_a_stackgraph_backup"><a class="anchor" href="#_restore_a_stackgraph_backup"></a>Restore a StackGraph backup</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>To avoid the unexpected loss of existing data, a backup can only be restored on a clean environment by default.</strong>
If you are completely sure that any existing data can be overwritten, you can override this safety feature by using the command <code>-force</code>.
Only execute the restore command when you are sure that you want to restore the backup.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To restore a StackGraph backup on a clean environment, select a backup name and pass it as the first parameter in the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/restore-stackgraph-backup.sh sts-backup-20210216-0300.graph</code></pre>
</div>
</div>
<div class="paragraph">
<p>To restore a StackGraph backup on an <strong>environment with existing data</strong>, select a backup name and pass it as the first parameter in the following command next to a second parameter <code>-force</code>:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Note that existing data will be overwritten when the backup is restored.</strong></p>
</div>
<div class="paragraph">
<p>Only do this if you are completely sure that any existing data can be overwritten.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/restore-stackgraph-backup.sh sts-backup-20210216-0300.graph -force</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">job.batch/stackgraph-restore-20210222t112142 created
Waiting for job to start...
=== Downloading StackGraph backup "sts-backup-20210216-0300.graph" from bucket "sts-stackgraph-backup"...
download: s3://sts-stackgraph-backup/sts-backup-20210216-1252.graph to ../../tmp/sts-backup-20210216-0300.graph
=== Importing StackGraph data from "sts-backup-20210216-0300.graph"...
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by org.codehaus.groovy.vmplugin.v7.Java7$1 (file:/opt/docker/lib/org.codehaus.groovy.groovy-2.5.4.jar) to constructor java.lang.invoke.MethodHandles$Lookup(java.lang.Class,int)
WARNING: Please consider reporting this to the maintainers of org.codehaus.groovy.vmplugin.v7.Java7$1
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
===
job.batch "stackgraph-restore-20210222t112142" deleted</code></pre>
</div>
</div>
<div class="paragraph">
<p>In case you are running a restore command missing the <code>-force</code> flag on a non-empty database the output will contain an error like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">ERROR com.stackvista.graph.migration.Restore - Restore isn't possible in a non empty.</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Lines that starts with <code>WARNING:</code> are expected. They&#8217;re generated by Groovy running in JDK 11 and can be ignored.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_list_victoria_metrics_backups"><a class="anchor" href="#_list_victoria_metrics_backups"></a>List Victoria Metrics backups</h3>
<div class="paragraph">
<p>To list the Victoria Metrics backups, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/list-victoria-metrics-backups.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">job.batch/victoria-metrics-list-backups-20231016t125557 created
Waiting for job to start...
Waiting for job to start...
=== Fetching timestamps of last completed incremental backups
victoria-metrics-0 victoria-metrics-0-20231128160000 "Wed, 29 Nov 2023 07:36:00 GMT"
victoria-metrics-0 victoria-metrics-0-20231129092200 "Wed, 29 Nov 2023 10:56:00 GMT"

===
job.batch "victoria-metrics-list-backups-20231016t125557" deleted</code></pre>
</div>
</div>
<div class="paragraph">
<p>where you can see the Victoria metrics instance, the specific backup version and the last time a backup was completed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_restore_a_victoria_metrics_backup"><a class="anchor" href="#_restore_a_victoria_metrics_backup"></a>Restore a Victoria Metrics backup</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Restore functionality always overrides data. You must be careful to avoid the unexpected loss of existing data.</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Restore functionality requires to stop an instance of Victoria Metric while the process.</strong></p>
</div>
<div class="paragraph">
<p>All new metrics will be cached by <code>vmagent</code> while the restore process, please ensure the <code>vmagent</code> has enough memory to cache metrics.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To restore a Victoria Metrics backup, select an instance name and a backup version and pass them as parameters in the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/restore-victoria-metrics-backup.sh victoria-metrics-0 victoria-metrics-0-20231128160000</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">=== Scaling down the Victoria Metrics instance
statefulset.apps/stackstate-victoria-metrics-0 scaled
=== Allowing pods to terminate
=== Starting restore job
job.batch/victoria-metrics-restore-backup-20231017t092607 created
=== Restore job started. Follow the logs with the following command:
kubectl logs --follow job/victoria-metrics-restore-backup-20231017t092607
=== After the job has completed clean up the job and scale up the Victoria Metrics instance pods again with the following commands:
kubectl delete job victoria-metrics-restore-backup-20231017t092607
kubectl scale statefulsets stackstate-victoria-metrics-0 --replicas=1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then follow logs to check the job status</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2023-10-17T07:26:42.564Z	info	VictoriaMetrics/lib/backup/actions/restore.go:194	restored 53072307269 bytes from backup in 0.445 seconds; deleted 639118752 bytes; downloaded 1204539 bytes
2023-10-17T07:26:42.564Z	info	VictoriaMetrics/app/vmrestore/main.go:64	gracefully shutting down http server for metrics at ":8421"
2023-10-17T07:26:42.564Z	info	VictoriaMetrics/app/vmrestore/main.go:68	successfully shut down http server for metrics in 0.000 seconds</pre>
</div>
</div>
<div class="paragraph">
<p>After completion (<strong>ensure if the backup has been restored successfully</strong>), it&#8217;s needed to follow commands printed by the earlier command:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>delete the restore job</p>
</li>
<li>
<p>scale up the Victoria Metrics instance</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_list_clickhouse_backups"><a class="anchor" href="#_list_clickhouse_backups"></a>List ClickHouse backups</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following script needs permission to execute the <code>kubectl exec</code> command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To list ClickHouse backups, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/list-clickhouse-backups.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">full_2024-06-17T18-50-00          34.41KiB   17/06/2024 18:50:00   remote                                      tar, regular
incremental_2024-06-17T18-51-00   7.29KiB    17/06/2024 18:51:00   remote   +full_2024-06-17T18-50-00          tar, regular
incremental_2024-06-17T18-54-00   7.29KiB    17/06/2024 18:54:00   remote   +incremental_2024-06-17T18-51-00   tar, regular
incremental_2024-06-17T18-57-00   7.29KiB    17/06/2024 18:57:00   remote   +incremental_2024-06-17T18-54-00   tar, regular
full_2024-06-17T19-00-00          26.41KiB   17/06/2024 19:00:00   remote                                      tar, regular
incremental_2024-06-17T19-00-00   6.52KiB    17/06/2024 19:00:00   remote   +incremental_2024-06-17T18-57-00   tar, regular
incremental_2024-06-17T19-03-00   25.37KiB   17/06/2024 19:03:00   remote   +incremental_2024-06-17T19-00-00   tar, regular
incremental_2024-06-17T19-06-00   7.29KiB    17/06/2024 19:06:00   remote   +incremental_2024-06-17T19-03-00   tar, regular</code></pre>
</div>
</div>
<div class="paragraph">
<p>where is printed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>name, the name started with <code>full_</code> - it is a full backup, <code>incremental_</code> - it is an incremental backup</p>
</li>
<li>
<p>size,</p>
</li>
<li>
<p>creation date,</p>
</li>
<li>
<p><code>remote</code> - a backup is upload to a remote storage like S3</p>
</li>
<li>
<p>parent backup - used by incremental backups</p>
</li>
<li>
<p>format and compression</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_restore_a_clickhouse_backup"><a class="anchor" href="#_restore_a_clickhouse_backup"></a>Restore a ClickHouse backup</h3>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Restore functionality always overrides data (all tables in the <code>otel</code> database). You must be careful to avoid the unexpected loss of existing data.</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The following script needs permission to execute the <code>kubectl exec</code> command.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Restore functionality requires stopping all producers (like OpenTelemetry exporters). The script scales the StatefulSet down and then back up afterward.</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To restore a ClickHouse backup, select a backup version and pass them as a parameter in the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/restore-clickhouse-backup.sh incremental_2024-06-17T18-57-00</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">...
2024/06/17 19:14:19.509498  info download object_disks start backup=incremental_2024-06-17T19-06-00 operation=restore_data table=otel.otel_traces_trace_id_ts_mv
2024/06/17 19:14:19.509530  info download object_disks finish backup=incremental_2024-06-17T19-06-00 duration=0s operation=restore_data size=0B table=otel.otel_traces_trace_id_ts_mv
2024/06/17 19:14:19.509549  info done                      backup=incremental_2024-06-17T19-06-00 duration=0s operation=restore_data progress=12/12 table=otel.otel_traces_trace_id_ts_mv
2024/06/17 19:14:19.509574  info done                      backup=incremental_2024-06-17T19-06-00 duration=66ms operation=restore_data
2024/06/17 19:14:19.509591  info done                      backup=incremental_2024-06-17T19-06-00 duration=167ms operation=restore version=2.5.13
2024/06/17 19:14:19.509684  info clickhouse connection closed logger=clickhouse
Data restored</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>Error: error can&#8217;t create table &#8230;&#8203;. code: 57, message: Directory for table data store/&#8230;&#8203;/ already exists</strong></p>
</div>
<div class="paragraph">
<p>ClickHouse does not permanently delete tables when the <code>DROP DATABASE/TABLE ...</code> command is executed. Instead, the database is marked as deleted and will be permanently removed after 8 minutes. This delay provides additional time to undo the operation. More details can be found at <a href="https://clickhouse.com/docs/en/sql-reference/statements/undrop">UNDROP TABLE</a>. If you attempt to restore data during this period, it will fail and produce the aforementioned error. Available solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>wait 8 minutes (check table <code>select * from system.dropped_tables;</code> )</p>
</li>
<li>
<p>configure <code>database_atomic_delay_before_drop_table_sec</code></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_list_elasticsearch_snapshots"><a class="anchor" href="#_list_elasticsearch_snapshots"></a>List Elasticsearch snapshots</h3>
<div class="paragraph">
<p>To list the Elasticsearch snapshots, execute the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/list-elasticsearch-snapshots.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">job.batch/elasticsearch-list-snapshots-20210224t133115 created
Waiting for job to start...
Waiting for job to start...
=== Listing Elasticsearch snapshots in snapshot repository "sts-backup" in bucket "sts-elasticsearch-backup"...
sts-backup-20210219-0300-mref7yrvrswxa02aqq213w
sts-backup-20210220-0300-yrn6qexkrdgh3pummsrj7e
sts-backup-20210221-0300-p481sih8s5jhre9zy4yw2o
sts-backup-20210222-0300-611kxendsvh4hhkoosr4b7
sts-backup-20210223-0300-ppss8nx40ykppss8nx40yk
===
job.batch "elasticsearch-list-snapshots-20210224t133115" deleted</code></pre>
</div>
</div>
<div class="paragraph">
<p>The timestamp when the backup was taken is part of the backup name.</p>
</div>
</div>
<div class="sect2">
<h3 id="_delete_elasticsearch_indices"><a class="anchor" href="#_delete_elasticsearch_indices"></a>Delete Elasticsearch indices</h3>
<div class="paragraph">
<p>To delete existing Elasticsearch indices so that a snapshot can be restored, follow these steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Stop indexing - scale down all <code>*2es</code> deployments to 0:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl scale --replicas=0 deployment/e2es</code></pre>
</div>
</div>
</li>
<li>
<p>Open a port-forward to the Elasticsearch master:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl port-forward service/stackstate-elasticsearch-master 9200:9200</code></pre>
</div>
</div>
</li>
<li>
<p>Get a list of all indices:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl "http://localhost:9200/_cat/indices?v=true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">health status index                          uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   sts_internal_events-2022.09.20 fTk7iEYtQI6ruVFuwNnbPw   1   0        125            0     71.7kb         71.7kb
green  open   .geoip_databases               GYA_c3i6QKenfFehnwBcAA   1   0         41            0     38.8mb         38.8mb
green  open   sts_multi_metrics-2022.09.20   MT1DceQPTDWVIfBJdl7qUg   3   0       1252            0    550.1kb        550.1kb</code></pre>
</div>
</div>
</li>
<li>
<p>Delete an index with a following command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -X DELETE "http://localhost:9200/INDEX_NAME?pretty"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>INDEX_NAME</code> with the name of the index to delete, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl -X DELETE "http://localhost:9200/sts_internal_events-2021.02.19?pretty"</code></pre>
</div>
</div>
</li>
<li>
<p>The output should be:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
"acknowledged" : true
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_restore_an_elasticsearch_snapshot"><a class="anchor" href="#_restore_an_elasticsearch_snapshot"></a>Restore an Elasticsearch snapshot</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><strong>When a snapshot is restored, existing indices won&#8217;t be overwritten.</strong></p>
</div>
<div class="paragraph">
<p>See <a href="kubernetes_backup.adoc#delete-elasticsearch-indices">delete Elasticsearch indices</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To restore an Elasticsearch snapshot, select a snapshot name and pass it as the first parameter in the following command line. You can optionally specify a second parameter with a comma-separated list of the indices that should be restored. If not specified, all indices that match the Helm value <code>backup.elasticsearch.scheduled.indices</code> will be restored (default <code>"sts*"</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./restore/restore-elasticsearch-snapshot.sh \
  sts-backup-20210223-0300-ppss8nx40ykppss8nx40yk \
  "&lt;INDEX_TO_RESTORE&gt;,&lt;INDEX_TO_RESTORE&gt;"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">job.batch/elasticsearch-restore-20210229t152530 created
Waiting for job to start...
Waiting for job to start...
=== Restoring Elasticsearch snapshot "sts-backup-20210223-0300-ppss8nx40ykppss8nx40yk" from snapshot repository "sts-backup" in bucket "sts-elasticsearch-backup"...
{
  "snapshot" : {
    "snapshot" : "sts-backup-20210223-0300-ppss8nx40ykppss8nx40yk",
    "indices" : [
      ".slm-history-1-000001",
      "ilm-history-1-000001",
      "sts_internal_events-2021.02.19"
    ],
    "shards" : {
      "total" : 3,
      "failed" : 0,
      "successful" : 3
    }
  }
}
===
job.batch "elasticsearch-restore-20210229t152530" deleted</code></pre>
</div>
</div>
<div class="paragraph">
<p>The indices restored are listed in the output, as well as the number of failed and successful restore actions.</p>
</div>
<div class="paragraph">
<p>After the indices have been restored, scale up all <code>*2es</code> deployments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">   kubectl scale --replicas=1 deployment/e2es</code></pre>
</div>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="README.html">Backup and Restore</a></span>
  <span class="next"><a href="configuration_backup.html">Configuration backup</a></span>
</nav>
</article>
  </div>
</main>
</div>
<script src="../../../../../../_/js/site.js"></script>
<script async src="../../../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../../.." data-snippet-length="100" data-stylesheet="../../../../../../_/css/search.css"></script>
<script async src="../../../../../../search-index.js"></script>
<script src="../../../../../../_/js/vendor/langSelection.js"></script>
<script async src="../../../../../../_/js/vendor/tabs.js"></script>


  </body>
</html>
